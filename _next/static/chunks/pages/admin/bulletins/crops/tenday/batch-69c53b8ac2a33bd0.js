(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[6268],{85786:function(e,t,n){(window.__NEXT_P=window.__NEXT_P||[]).push(["/admin/bulletins/crops/tenday/batch",function(){return n(26390)}])},26390:function(e,t,n){"use strict";n.r(t);var i=n(85893),r=n(67294),s=n(9473),a=n(45773),l=n(65328),o=n(60990),c=n(51015),d=n(60762),u=n(71919),p=n(12166),h=n(81873),x=n(33453),g=n(40110),m=n(92365),v=n(65806),f=n(56894),j=n(68573),Z=n(52857),b=n(92608),y=n(26541),S=n(96788),w=n(25837),C=n(44723),k=n(97182),B=n(84166),E=n(13539),_=n(95639),T=n(97416),P=n(31695),N=n(75941),R=n(46560),G=n(98813),D=n(96281),M=n(77457),I=n(9704),W=n(38660);let A={card:{padding:"16px",borderRadius:"8px",border:"1px solid #e0e0e0"},progressSection:{marginTop:"24px",padding:"16px",backgroundColor:"#f5f5f5",borderRadius:"8px"}};t.default=(0,l.Z)(function(e){var t;let{user:n,onBtnLogoutClick:l,loading:F}=e,z=(0,r.useRef)(!0),L=(0,r.useRef)(0),O=(0,s.I0)(),[q,U]=(0,r.useState)(null),[X,Q]=(0,r.useState)([]),[Y,J]=(0,r.useState)([]),[$,H]=(0,r.useState)([]),[K,V]=(0,r.useState)([]),[ee,et]=(0,r.useState)([]),[en,ei]=(0,r.useState)([]),[er,es]=(0,r.useState)([]),[ea,el]=(0,r.useState)(!0),[eo,ec]=(0,r.useState)(null),[ed,eu]=(0,r.useState)({open:!1,url:"",filename:"",loading:!1,error:"",municipality:""}),{cropList:ep}=(0,I.Z)(),{services:eh}=(0,W.Z)(void 0,void 0),ex=ep.map(e=>({label:e,id:e})),[eg,em]=(0,r.useState)({isGenerating:!1,current:0,total:0,message:"",errors:[],generated:[],success:!1}),ev=()=>{em({isGenerating:!1,current:0,total:0,message:"",errors:[],generated:[],success:!1})};(0,r.useEffect)(()=>(z.current=!0,(async()=>{try{let e=await (0,T.$m)();z.current&&(H(e.data||[]),J((0,D.m)(e.data)))}catch(e){console.error("Error loading provinces:",e)}})(),()=>{z.current=!1}),[]),(0,r.useEffect)(()=>{V([]),et([]),ei([]),es([]),ev()},[q,X]),(0,r.useEffect)(()=>{if(0===X.length){ec(null);return}eo&&X.includes(eo)||ec(X[0])},[X,eo]);let ef=e=>{Q(t=>t.includes(e)?t.filter(t=>t!==e):[...t,e])},ej=e=>{et(t=>t.includes(e)?t.filter(t=>t!==e):[...t,e])},eZ=(0,r.useCallback)(async function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;if(!q||0===X.length){alert("Please select a province and at least one crop");return}em(e=>({...e,isGenerating:!0,current:0,total:0,message:"Checking available municipalities...",errors:[],generated:[],success:!1}));try{var t;let n=null!=e?e:++L.current,i=await O((0,N.JC)({region:"mimaropa",province:q.label,crops:X})).unwrap();if(n!==L.current)return;let r=i.drafts||[],s=i.errors||[],a=new Map,l=new Map;s.forEach(e=>{if(!(null==e?void 0:e.municipality)||!(null==e?void 0:e.crop))return;l.has(e.municipality)||l.set(e.municipality,new Map);let t=l.get(e.municipality);t.has(e.crop)||t.set(e.crop,[]),t.get(e.crop).push(e.error)}),r.forEach(e=>{a.has(e.municipality)||a.set(e.municipality,new Set),a.get(e.municipality).add(e.crop)});let o=$.find(e=>e.label===q.label),c=((null==o?void 0:o.municipalities)||[]).map(e=>e.label).map(e=>{let t=a.get(e)||new Set,n=X.filter(e=>!t.has(e)),i=n.map(t=>{var n;let i=(null===(n=l.get(e))||void 0===n?void 0:n.get(t))||[];return{crop:t,reason:i[0]||"Missing data"}});return{municipality:e,status:0===n.length?"complete":"incomplete",missing:i}}),d=Array.from(a.entries()).filter(e=>{let[,t]=e;return t.size===X.length}).map(e=>{let[t]=e;return t}),u=new Set(d),p=r.filter(e=>u.has(e.municipality));ei(p),V(d),et(d),es(c);let h=(null==o?void 0:null===(t=o.municipalities)||void 0===t?void 0:t.length)||0;em({isGenerating:!1,current:i.success+i.failed,total:i.totalToGenerate,message:d.length>0?"Found ".concat(d.length," of ").concat(h," municipalities with complete data. Select municipalities to save."):"No municipalities have complete data for the selected crops.",errors:s,generated:p,success:d.length>0})}catch(e){em(t=>({...t,isGenerating:!1,message:"Error checking data: ".concat(e),errors:[{error:e.toString()}],success:!1}))}},[O,$,q,X]);(0,r.useEffect)(()=>{if(!q||0===X.length)return;let e=++L.current,t=setTimeout(()=>{eZ(e)},400);return()=>clearTimeout(t)},[eZ,q,X]);let eb=async e=>{if(!q||!eo){alert("Please select a crop for preview");return}eu(t=>({...t,loading:!0,error:"",open:!0,municipality:e}));try{let t={region:"mimaropa",province:q.label,municipality:e,operation:"preview",language:ea?"en":"tag",crop:eo,services:eh.map(e=>e.data)},n=await (0,P.bM)(t),i=new Blob([n],{type:"application/pdf"}),r=URL.createObjectURL(i),s="".concat(q.label,"_").concat(e,"_").concat(eo,".pdf");eu({open:!0,url:r,filename:s,loading:!1,error:"",municipality:e})}catch(t){let e=await (0,M.fu)(t);eu(t=>({...t,loading:!1,error:e||"Failed to load preview."}))}},ey=()=>{ed.url&&URL.revokeObjectURL(ed.url),eu({open:!1,url:"",filename:"",loading:!1,error:"",municipality:""})},eS=async()=>{if(!en.length)return;if(0===ee.length){alert("Please select at least one municipality to save");return}let e=new Set(ee),t=en.filter(t=>e.has(t.municipality));if(0===t.length){alert("No draft bulletins available for the selected municipalities");return}em(e=>({...e,isGenerating:!0,message:"Saving to server..."}));try{let e=await O((0,N.il)(t)).unwrap();em({isGenerating:!1,current:e.saved,total:e.saved,message:"Saved ".concat(e.saved," bulletins to server!"),errors:e.errors||[],generated:[],success:!0}),ei([]),V([]),et([]),O((0,R.uq)(G.Ry.TEN_DAY)),O((0,N.RC)({uid:n.uid,type:G.Ry.TEN_DAY}))}catch(e){em(t=>({...t,isGenerating:!1,message:"Error saving: ".concat(e),errors:[{error:e.toString()}],success:!1}))}},ew=eg.isGenerating,eC=eg.total>0?Math.round(eg.current/eg.total*100):0,ek=K.length>0&&ee.length===K.length,eB=ee.length>0&&!ek,eE=$.find(e=>e.label===(null==q?void 0:q.label)),e_=(null==eE?void 0:null===(t=eE.municipalities)||void 0===t?void 0:t.length)||0,eT=er.filter(e=>"complete"===e.status),eP=er.filter(e=>"incomplete"===e.status);return(0,i.jsx)(a.Z,{loading:F,user:n,onBtnLogoutClick:l,accLevel:G.DW.ADMIN,children:(0,i.jsxs)(o.Z,{sx:{padding:"24px"},children:[(0,i.jsx)(S.Z,{variant:"h4",sx:{marginBottom:"8px"},children:"Batch 10-Day Bulletin Generation"}),(0,i.jsx)(S.Z,{variant:"body2",sx:{marginBottom:"24px",color:"#666"},children:"Generate 10-Day bulletins for municipalities with complete data in a province with multiple crops in one operation."}),(0,i.jsxs)(j.ZP,{container:!0,spacing:3,children:[(0,i.jsx)(j.ZP,{item:!0,xs:12,md:6,children:(0,i.jsx)(d.Z,{sx:A.card,children:(0,i.jsxs)(u.Z,{children:[(0,i.jsx)(S.Z,{variant:"h6",sx:{marginBottom:"16px"},children:"Selection Options"}),(0,i.jsx)(o.Z,{sx:{marginBottom:"16px"},children:(0,i.jsx)(w.Z,{disabled:ew,options:Y,value:q,onChange:(e,t)=>{U(t)},renderInput:e=>(0,i.jsx)(y.Z,{...e,label:"Select Province",size:"small"})})}),(0,i.jsx)(S.Z,{variant:"subtitle2",sx:{marginBottom:"12px"},children:"Select Crops (Only enabled crops with data will be generated):"}),(0,i.jsx)(f.Z,{children:ex.map(e=>(0,i.jsx)(v.Z,{control:(0,i.jsx)(p.Z,{checked:X.includes(e.label),onChange:()=>ef(e.label),disabled:ew}),label:e.label},e.id))}),0===X.length&&(0,i.jsx)(C.Z,{severity:"info",sx:{marginTop:"12px"},children:"Select at least one crop to proceed"}),X.length>0&&(0,i.jsx)(o.Z,{sx:{marginTop:"16px"},children:(0,i.jsxs)(B.Z,{direction:"row",spacing:2,alignItems:"center",children:[(0,i.jsx)(v.Z,{control:(0,i.jsx)(E.Z,{checked:ea,onChange:e=>el(e.target.checked)}),label:ea?"English":"Tagalog"}),(0,i.jsx)(w.Z,{disabled:ew,options:X.map(e=>({label:e,id:e})),value:eo?{label:eo,id:eo}:null,onChange:(e,t)=>ec((null==t?void 0:t.label)||null),sx:{minWidth:"200px"},renderInput:e=>(0,i.jsx)(y.Z,{...e,label:"Preview Crop",size:"small"})})]})}),K.length>0&&(0,i.jsxs)(o.Z,{sx:{marginTop:"16px"},children:[(0,i.jsx)(S.Z,{variant:"subtitle2",sx:{marginBottom:"12px"},children:"Select Municipalities (with complete data):"}),(0,i.jsxs)(f.Z,{children:[(0,i.jsx)(v.Z,{control:(0,i.jsx)(p.Z,{checked:ek,indeterminate:eB,onChange:()=>{if(ee.length===K.length){et([]);return}et(K)}}),label:"Select All"}),K.map(e=>(0,i.jsx)(v.Z,{control:(0,i.jsx)(p.Z,{checked:ee.includes(e),onChange:()=>ej(e),disabled:ew}),label:e},e))]})]}),er.length>0&&(0,i.jsxs)(o.Z,{sx:{marginTop:"16px"},children:[(0,i.jsx)(S.Z,{variant:"subtitle2",sx:{marginBottom:"12px"},children:"Municipality Status"}),(0,i.jsx)(B.Z,{spacing:1,children:er.map(e=>(0,i.jsxs)(o.Z,{sx:{padding:"8px 12px",borderRadius:"6px",border:"1px solid #e0e0e0"},children:[(0,i.jsxs)(B.Z,{direction:"row",spacing:1,alignItems:"center",children:[(0,i.jsx)(S.Z,{variant:"body2",sx:{fontWeight:600},children:e.municipality}),(0,i.jsx)(h.Z,{size:"small",label:"complete"===e.status?"Complete":"Incomplete",color:"complete"===e.status?"success":"warning"}),"complete"===e.status&&(0,i.jsx)(c.Z,{size:"small",variant:"outlined",onClick:()=>eb(e.municipality),disabled:ew||!eo,children:"Preview"})]}),"incomplete"===e.status&&e.missing.length>0&&(0,i.jsx)(o.Z,{sx:{marginTop:"6px"},children:e.missing.map(t=>(0,i.jsxs)(S.Z,{variant:"caption",display:"block",sx:{color:"#d32f2f"},children:[t.crop,": ",t.reason]},"".concat(e.municipality,"-").concat(t.crop)))})]},e.municipality))})]}),q&&X.length>0&&0===K.length&&eg.message&&(0,i.jsx)(C.Z,{severity:"warning",sx:{marginTop:"12px"},children:"No municipalities found with complete data for the selected crops."})]})})}),(0,i.jsx)(j.ZP,{item:!0,xs:12,md:6,children:(0,i.jsx)(d.Z,{sx:A.card,children:(0,i.jsxs)(u.Z,{children:[(0,i.jsx)(S.Z,{variant:"h6",sx:{marginBottom:"16px"},children:"Generation Summary"}),(0,i.jsxs)(o.Z,{sx:{marginBottom:"12px"},children:[(0,i.jsxs)(S.Z,{variant:"body2",children:[(0,i.jsx)("strong",{children:"Province:"})," ",q?q.label:"Not selected"]}),(0,i.jsxs)(S.Z,{variant:"body2",children:[(0,i.jsx)("strong",{children:"Selected Crops:"})," ",X.length>0?X.join(", "):"None"]}),(0,i.jsxs)(S.Z,{variant:"body2",children:[(0,i.jsx)("strong",{children:"Municipalities Selected:"})," ",ee.length>0?"".concat(ee.length," selected"):"None"]}),(0,i.jsxs)(S.Z,{variant:"body2",children:[(0,i.jsx)("strong",{children:"Municipalities Available:"})," ",q?"".concat(K.length," of ").concat(e_):"N/A"]}),(0,i.jsxs)(S.Z,{variant:"body2",children:[(0,i.jsx)("strong",{children:"Status:"})," ",er.length>0?"".concat(eT.length," complete, ").concat(eP.length," incomplete"):"Not checked"]})]}),q&&X.length>0&&(0,i.jsxs)(C.Z,{severity:"info",children:["Will generate bulletins only for municipalities with complete data in"," ",(0,i.jsx)("strong",{children:q.label})," for each selected crop"]})]})})}),(0,i.jsx)(j.ZP,{item:!0,xs:12,children:(0,i.jsxs)(o.Z,{sx:{display:"flex",gap:"12px"},children:[(0,i.jsx)(c.Z,{variant:"contained",color:"primary",onClick:()=>eZ(),disabled:ew||!q||0===X.length,sx:{minWidth:"200px"},children:ew?(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(k.Z,{size:20,sx:{marginRight:"8px"}}),"Checking..."]}):"Recheck Data"}),eg.success&&ee.length>0&&(0,i.jsx)(c.Z,{variant:"contained",color:"success",onClick:eS,sx:{minWidth:"200px"},children:"✓ Save Selected Bulletins"}),(0,i.jsx)(c.Z,{variant:"outlined",onClick:()=>{U(null),Q([]),V([]),et([]),ei([]),ev()},disabled:ew,children:"Reset"})]})}),eg.message&&(0,i.jsx)(j.ZP,{item:!0,xs:12,children:(0,i.jsxs)(o.Z,{sx:A.progressSection,children:[(0,i.jsx)(S.Z,{variant:"h6",sx:{marginBottom:"12px"},children:"Generation Progress"}),ew&&(0,i.jsxs)(i.Fragment,{children:[(0,i.jsxs)(o.Z,{sx:{display:"flex",justifyContent:"space-between",marginBottom:"8px"},children:[(0,i.jsxs)(S.Z,{variant:"body2",children:[eg.current," / ",eg.total]}),(0,i.jsxs)(S.Z,{variant:"body2",children:[eC,"%"]})]}),(0,i.jsx)(b.Z,{variant:"determinate",value:eC,sx:{marginBottom:"12px",height:"8px"}})]}),(0,i.jsx)(C.Z,{severity:eg.success?"success":ew?"info":"error",sx:{marginBottom:"12px"},children:eg.message}),eg.errors.length>0&&(0,i.jsxs)(o.Z,{sx:{marginTop:"12px"},children:[(0,i.jsx)(S.Z,{variant:"subtitle2",sx:{marginBottom:"8px",color:"#d32f2f"},children:"Errors:"}),eg.errors.slice(0,5).map((e,t)=>(0,i.jsxs)(S.Z,{variant:"caption",display:"block",sx:{color:"#d32f2f",marginBottom:"4px"},children:["• ",e.municipality," - ",e.crop,": ",e.error]},t)),eg.errors.length>5&&(0,i.jsxs)(S.Z,{variant:"caption",sx:{color:"#d32f2f"},children:["... and ",eg.errors.length-5," more errors"]})]}),eg.generated.length>0&&(0,i.jsxs)(o.Z,{sx:{marginTop:"12px"},children:[(0,i.jsxs)(S.Z,{variant:"subtitle2",sx:{marginBottom:"8px",color:"#388e3c"},children:["Successfully Generated (",eg.generated.length,"):"]}),eg.generated.slice(0,5).map((e,t)=>(0,i.jsxs)(S.Z,{variant:"caption",display:"block",sx:{color:"#388e3c",marginBottom:"4px"},children:["✓ ",e.municipality," - ",e.crop]},t)),eg.generated.length>5&&(0,i.jsxs)(S.Z,{variant:"caption",sx:{color:"#388e3c"},children:["... and ",eg.generated.length-5," more"]})]})]})})]}),(0,i.jsxs)(x.Z,{open:ed.open,onClose:ey,fullWidth:!0,maxWidth:"lg",children:[(0,i.jsxs)(m.Z,{children:["Preview: ",ed.municipality||"Municipality",(0,i.jsx)(Z.Z,{"aria-label":"close",onClick:ey,sx:{position:"absolute",right:8,top:8},children:(0,i.jsx)(_.Z,{})})]}),(0,i.jsxs)(g.Z,{dividers:!0,children:[ed.loading&&(0,i.jsx)(o.Z,{sx:{display:"flex",justifyContent:"center",padding:"24px"},children:(0,i.jsx)(k.Z,{})}),ed.error&&(0,i.jsx)(C.Z,{severity:"error",sx:{marginBottom:"12px"},children:ed.error}),ed.url&&(0,i.jsx)(o.Z,{sx:{height:"70vh"},children:(0,i.jsx)("iframe",{title:"10-day preview",src:ed.url,style:{width:"100%",height:"100%",border:"none"}})})]})]})]})})})},9704:function(e,t,n){"use strict";n.d(t,{Z:function(){return s}});var i=n(67294),r=n(61061);function s(){let[e,t]=(0,i.useState)([]),[n,s]=(0,i.useState)(!1),[a,l]=(0,i.useState)("");return(0,i.useEffect)(()=>{(async()=>{var e,n,i;try{s(!0);let n=await (0,r.TQ)();t(null!==(e=null==n?void 0:n.list)&&void 0!==e?e:[]),s(!1),l("")}catch(e){l(null!==(i=null==e?void 0:null===(n=e.response)||void 0===n?void 0:n.data)&&void 0!==i?i:e.message),s(!1),t([])}})()},[]),{cropList:e,loading:n,error:a}}},38660:function(e,t,n){"use strict";n.d(t,{Z:function(){return s}});var i=n(67294),r=n(98037);function s(e,t){let[n,s]=(0,i.useState)([]),[a,l]=(0,i.useState)(!1),[o,c]=(0,i.useState)(!1);return(0,i.useEffect)(()=>{(async()=>{try{let e=await (0,r.yZ)();s(null!=e?e:[])}catch(n){var e,t;c(null!==(t=null==n?void 0:null===(e=n.response)||void 0===e?void 0:e.data)&&void 0!==t?t:n.message),l(!1)}})()},[e,t]),{services:n,loading:a,error:o}}},98037:function(e,t,n){"use strict";n.d(t,{Wn:function(){return o},vo:function(){return d},yZ:function(){return l},Ef:function(){return c}});var i=n(96171),r=n(36100);class s extends i.Z{constructor(...e){super(...e),this.getSupportServices=async()=>{let e=this.collection(this.db,"support_services"),t=this.query(e,(0,r.Xo)("date","asc"));return(await this.getDocs(t)).docs.map(e=>({...e.data(),docId:e.id}))},this.addSupportService=async e=>{let{supportService:t}=e,n=this.collection(this.db,"support_services");await this.addDoc(n,{data:t,date:new Date})},this.updateSupportService=async e=>{let t=this.collection(this.db,"support_services"),n=this.doc(t,e.docId);delete e.docId,await this.updateDoc(n,e)},this.deleteSupportService=async e=>{let t=this.doc(this.db,"support_services",e);await this.deleteDoc(t)}}}let a=new s,l=a.getSupportServices.bind(a),o=a.addSupportService.bind(a),c=a.updateSupportService.bind(a),d=a.deleteSupportService.bind(a)},77457:function(e,t,n){"use strict";n.d(t,{aS:function(){return s},fu:function(){return a}});var i=n(98813);let r=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;return parseFloat(e).toFixed(t)},s=e=>e===i.nQ?i.DD:r(e),a=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:void 0;return new Promise(t=>{if(void 0===e||"object"!=typeof e)t("Missing error response object");else if(e.response){if(e.response.data instanceof Blob){let n=new Blob([e.response.data],{type:"application/octet-stream"}),i=new FileReader;i.onload=()=>{t(i.result)},i.readAsText(n)}else t("Error reading data")}else e.request?t(e.request):t(e.message)})}},96281:function(e,t,n){"use strict";n.d(t,{m:function(){return i}});let i=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"label";return e.map((e,n)=>({id:n,label:e[t]}))}}},function(e){e.O(0,[3153,7023,3745,1664,6541,8848,6294,6905,5837,9998,4723,3539,7235,8591,2888,9774,179],function(){return e(e.s=85786)}),_N_E=e.O()}]);